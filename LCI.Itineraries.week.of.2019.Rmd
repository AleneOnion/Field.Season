---
output: 
  word_document:
    reference_docx: word_styles-reference-itineraries.docx
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
library(openxlsx)
library(dplyr)

#read in table types
time<-read.xlsx("data/New York State Office of Information Technology Services/Sampling Season - Documents/LCI.Field.Season.xlsx" , 3, detectDates = FALSE)
time$Time<-convertToDateTime(time$Time)
time$time.to.drive.to.next<-convertToDateTime(time$time.to.drive.to.next)
time$Trip.Total<-convertToDateTime(time$Trip.Total)
time$Day.Total<-convertToDateTime(time$Day.Total)
access<-read.xlsx("data/New York State Office of Information Technology Services/Sampling Season - Documents/LCI.Field.Season.xlsx" , 2)
float<-read.xlsx("data/New York State Office of Information Technology Services/Sampling Season - Documents/LCI.Field.Season.xlsx" , 4, detectDates = FALSE)
float$Departure<-convertToDateTime(float$Departure)
bottles<-read.xlsx("data/New York State Office of Information Technology Services/Sampling Season - Documents/LCI.Field.Season.xlsx", 5)

#rename headers
colnames(bottles)[colnames(bottles)=="Lake"]<-"Lake.short"
colnames(bottles)[colnames(bottles)=="matching"]<-"Lake"
#realine the table
library(tidyr)
bottles <- bottles %>% 
  gather(type, sample, Sample1:Sample4)
#truncate
bottles<-unique(bottles[c('Lake','type','sample','layer')])
#remove QA samples
bottles<-bottles[bottles$Lake!="none",]
bottles<-unique(bottles[c('Lake','type','sample','layer')])
#spread
bottles <- bottles %>% 
  spread(layer,sample)
#change type to trip
bottles$type<-gsub("Sample","",bottles$type)
colnames(bottles)[colnames(bottles)=="type"]<-"Trip"


#restrict and merge the tables
access<-unique(access[c('Lake','Y_Coordinate','X_Coordinate','access.site_lat','access.site_lon','Access','needs.big.boat','motor','Depth','map')])
time$NA.<-NULL
itinerary<-merge(time,access,by=c('Lake'),all=TRUE)
itinerary<-merge(itinerary,float,by=c('basin','Trip','team','Day'),all = TRUE)
itinerary<-merge(itinerary,bottles,by=c('Lake','Trip'),all=TRUE)
rm(list=c('access','time','float','bottles'))
itinerary$needs.big.boat<-ifelse(is.na(itinerary$needs.big.boat),"No",itinerary$needs.big.boat)
itinerary$motor<-ifelse(is.na(itinerary$motor),"No",itinerary$motor)
itinerary<-itinerary %>% 
  arrange(Trip,basin,team,Day,Order)
itinerary<-itinerary[!is.na(itinerary$basin),]
itinerary$Time<-gsub("1899-12-30 ","",itinerary$Time)
itinerary$time.to.drive.to.next<-gsub("1899-12-30 ","",itinerary$time.to.drive.to.next)
itinerary$Trip.Total<-gsub("1899-12-31 ","",itinerary$Trip.Total)
itinerary$Trip.Total<-gsub("1899-12-30 ","",itinerary$Trip.Total)
itinerary$Day.Total<-gsub("1899-12-30 ","",itinerary$Day.Total)



#################################################################################################################
#################################################################################################################
#################################################################################################################
#################################################################################################################
#################################################################################################################
#################################################################################################################
#restrict to only a portion of the itineraries
itinerary<-itinerary[itinerary$basin=="Oneida",]
itinerary<-itinerary[itinerary$Trip=="4",]
#itinerary<-itinerary[itinerary$team=="2",]
#itinerary<-itinerary[itinerary$Day=="3",]
#################################################################################################################
#################################################################################################################
#################################################################################################################
#################################################################################################################
#################################################################################################################
#################################################################################################################


itinerary<-itinerary %>% 
  arrange(Trip,basin,team,Day,Order)

```


```{r echo = FALSE, results = "asis", message=FALSE, warning=FALSE}
#try this: https://stackoverflow.com/questions/36674824/use-loop-to-generate-section-of-text-in-rmarkdown

template1 <- "##     page break\n
______________________________________________________________________________________\n
Trip: %s - Trip %s - Team %s\n
Time to travel to first site: %s\n
Trip total time: %s\n
These locations are stored on google map:\n
 https://tinyurl.com/y5eku8cg \n
\n
\n" 

template2 <- "......................................................................................\n
Day: %s (total time needed for the day: %s)\n
Team: %s, %s\n
Lake: %s (class %s; sampleIDs: %s, %s)\n
Access location: %s, %s || Deep Hole: %s,%s || Max Depth: %s\n
QC Sample to collect: %s\n
Estimated Sampling Time: %s hours || Estimated time to travel to the next site: %s\n
Does it need a big boat: %s || Motor specifications: %s\n
Access Information: %s\n
map: %s\n
\n
\n" # dont't forget the newline

template3 <- "......................................................................................\n
Day: %s (total time needed for the day: %s)\n
%s\n
Estimated 30 min to ship samples at UPS store and no time to travel to the hotel. \n
Time to next: %s\n
\n
\n" # dont't forget the newline






for (i in seq(nrow(itinerary))) {
  current <- itinerary[i, ]
  #use template 2 for every 10 records (includes a line break) and template 1 for all others
  if(is.na(current$class)){
    if(current$Lake=="Start"){
        cat(sprintf(template1, current$basin, current$Trip,current$team,current$time.to.drive.to.next,current$Trip.Total))
    }
    if(current$Lake!="Start"){
        cat(sprintf(template3, current$Day,current$Day.Total,current$Lake,current$time.to.drive.to.next))
    }
    }
  
  if(!is.na(current$class)){
      cat(sprintf(template2, current$Day,current$Day.Total,current$Crew.Leader,current$Crew.Members,current$Lake, current$class,current$epi,current$hyp,current$access.site_lat,current$access.site_lon,current$Y_Coordinate,
                  current$X_Coordinate,current$Depth,current$QC,current$Time, current$time.to.drive.to.next, current$needs.big.boat, current$motor, current$Access,current$map))
  }
}

rm(list=ls())
```
